<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>增删查改</title>
    <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/color.css">
    <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/demo/demo.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>
</head>
<body>
<!--table中的url会发送一个currentPage和pageSize的参数（默认为1,10.可以修改），也可以带参数发送-->
<table id="dg" title="用户表" class="easyui-datagrid" style="width:1000px;height:500px"
       url="/selectPage" toolbar="#toolbar" pagination="true"
       rownumbers="true" fitColumns="true" singleSelect="false" checkOnSelect="true"
       pageNumber="1" pageSize="5" pageList=[5,10,15] >
    <thead>
    <tr>
<!--        <th field="id" width="30" hidden>ID</th>-->
        <th field="id" checkbox="true"></th>
        <th field="name" width="20">姓名</th>
        <th field="spellName" width="30">姓名简拼</th>
        <th field="sex" width="12">性别</th>
        <th field="idType" width="20">证件类型</th>
        <th field="idNumber" width="50">身份证编号</th>
        <th field="birthday" width="30">出生日期</th>
        <th field="phoneNumber" width="30">手机号码</th>
        <th field="email" width="50">电子邮箱</th>
    </tr>
    </thead>
</table>
<div id="toolbar">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="newUser()">新建用户</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-edit" plain="true"
       onclick="editUser()">编辑用户</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="destroyUser()">删除用户</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" plain="false" onclick="fresh()">刷新列表</a>
    <input id="ss" class="easyui-searchbox" style="width:280px"
           data-options="searcher:qq,prompt:'请输入查询的关键字',menu:'#mm'">
    <div id="mm" style="width:120px">
        <div data-options="name:'Column_2',iconCls:'icon-ok'">姓名</div>
        <div data-options="name:'Column_8'">手机号</div>
        <div data-options="name:'Column_6'">身份证号码</div>
    </div>&nbsp;&nbsp;&nbsp;
    <a href="/down" class="easyui-linkbutton" data-options="iconCls:'icon-print'" data-cmd="exportFile">导出excel</a>
    <form id="file" enctype="multipart/form-data" method="post">
        <input id="choseFile" class="easyui-filebox" style="width:200px" name="file" data-options="required:true">
        <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-save" plain="false" onclick="update()">上传</a>
    </form>
</div>

<div id="dlg" class="easyui-dialog" style="width:450px"
     data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons'">
    <form id="fm" method="post" novalidate style="margin:0;padding:20px 50px">
        <h3>用户信息</h3>
        <div style="margin-bottom:10px" hidden>
            <input name="id" class="easyui-tesxtbox" data-options="required:false" label="ID:" style="width:100%"
                   readonly>
        </div>
        <div style="margin-bottom:10px">
            <input name="name" class="easyui-textbox" required="true" label="姓名:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="spellName" class="easyui-textbox" required="true" label="姓名简拼:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="sex" class="easyui-textbox" required="true" label="性别:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="idType" class="easyui-textbox" required="true" label="证件类型:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="idNumber" class="easyui-textbox" required="true" label="身份证编号:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="birthday" class="easyui-datebox" required="true" label="出生日期:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="phoneNumber" class="easyui-textbox" required="true" label="手机号码:" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input name="email" class="easyui-textbox" required="true" validType="email" label="Email:"
                   style="width:100%">
        </div>
    </form>
</div>
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveUser()" style="width:90px">Save</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
       onclick="javascript:$('#dlg').dialog('close')" style="width:90px">Cancel</a>
</div>
<script type="text/javascript">

    //刷新页面
    function fresh(){
        location.reload();
        // $('#ss').searchbox('setValue','');
        // $('#dg').datagrid({
        //     queryParams: {
        //         name: "",
        //         value: ""
        //     }
        // });
    }

    //更新用户信息
    function update(){
        $('#file').form('submit', {
            url:"/update",
            onSubmit: function(){
                let form = $(this).form('validate');
                if (!form) {
                    $.messager.alert("消息", "请选择上传文件");
                    return false;
                }
                return true;
            },
            success:function(data){
                $(this).form("clear");
                $.messager.alert("消息", data);
                $('#dg').datagrid('reload');
            }
        });
    }

    //上传文件设置（可以选择 *.xls & *.xlsx 的文件）
    $("#choseFile").filebox({
        buttonText:"选择文件",
        buttonAlign:"right",
        accept:"application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    })

    //搜索框发起带参数的请求
    function qq(value,name){
        if (!value){
            $.messager.alert("消息", "请输入关键字");
        } else {
            // alert(name+"-->"+value);
            $('#dg').datagrid({
                queryParams: {
                    name: name,
                    value: value.trim()
                }
            });
            // $('#dg').datagrid('reload');
        }
    }

    //打开创建窗口
    function newUser() {
        $('#dlg').dialog('open').dialog('center').dialog('setTitle', 'User');
        $('#fm').form('clear');
    }

    //打开编辑窗口渲染行内的数据
    function editUser() {
        var row = $('#dg').datagrid('getChecked');
        var rowDate = $('#dg').datagrid('getSelected');
        if (row.length>1){
            $.messager.alert("消息", "一次只能修改一条数据");
        } else if (row) {
            $('#dlg').dialog('open').dialog('center').dialog('setTitle', 'User');
            $('#fm').form('load', rowDate);
        }
    }

    //验证表单，提交表单
    function saveUser() {
        $('#fm').form('submit', {
            url: "/saveOrUpdate",
            onSubmit: function () {
                //表单验证（隐藏的id属性require设置为false）
                let form = $(this).form('validate');
                if (!form) {
                    $.messager.alert("消息", "没有填写完整");
                    return false;
                }
                return true;
            },
            success: function (result) {
                // var result = eval('(' + result + ')');
                if (!result) {
                    $.messager.alert("消息", "提交失败");
                } else {
                    $('#ss').searchbox('setValue', '');
                    $('#dg').datagrid({
                        queryParams: {
                            name: "",
                            value: ""
                        }
                    });
                    $.messager.alert("消息", "操作成功");
                    $('#dlg').dialog('close');        // close the dialog
                    $('#dg').datagrid('reload');    // reload the user data
                }
            }
        });
    }

    function destroyUser() {
        // var row = $('#dg').datagrid('getSelected');//获取单独的列
        var rowDate = $('#dg').datagrid('getChecked');//获取check的列
        var data = [];
        $.each(rowDate, function (i, e) {
            data[i] = e.id;
        })
        console.log(data);
        if (data) {
            $.messager.confirm('警告', '确定要删除吗？', function (r) {
                if (r) {
                    $.ajax({
                        type: "post",
                        url: "/delete",
                        data: {ids:data},
                        traditional: true,
                        success: function (result){
                            if (result == 1) {
                                $.messager.alert("消息", "操作成功");
                                $('#dg').datagrid('reload');    // reload the user data
                            } else {
                                $.messager.show({    // show error message
                                    title: 'Error',
                                    msg: "删除失败,请稍后再试！"
                                });
                            }
                        }
                    })
                }
            });
        }
    }
</script>
</body>
</html>